worker_processes auto;
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events { worker_connections 1024; }

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # Добавляем поддержку .mjs
    types { application/javascript mjs; }

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    access_log /var/log/nginx/access.log main;

    sendfile on;
    keepalive_timeout 65;
    server_tokens off;

    upstream php-handler {
        server app:9000;
    }

    server {
        listen 80;
        server_name nextcloud.flexites.org;

        root /var/www/html;
        index index.php index.html;

        autoindex off;

        client_max_body_size 512M;
        client_body_timeout 300s;

        # --- Let's Encrypt challenge ---
        location ^~ /.well-known/acme-challenge/ {
            root /opt/nextcloud_stack/certbot;
            try_files $uri =404;
        }

        # --- well-known для Nextcloud ---
        location = /.well-known/webfinger        { return 301 /index.php$uri; }
        location = /.well-known/nodeinfo         { return 301 /index.php$uri; }
        location = /.well-known/carddav          { return 301 /remote.php/dav/; }
        location = /.well-known/caldav           { return 301 /remote.php/dav/; }
        location = /.well-known/host-meta        { return 301 /public.php?service=host-meta; }
        location = /.well-known/host-meta.json   { return 301 /public.php?service=host-meta-json; }

        # --- Security headers ---
        add_header Strict-Transport-Security "max-age=15552000; includeSubDomains" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header X-Permitted-Cross-Domain-Policies "none" always;
        add_header Referrer-Policy "no-referrer" always;
        add_header X-Robots-Tag "noindex,nofollow" always;

        # robots.txt
        location = /robots.txt { allow all; log_not_found off; access_log off; }

        # deny sensitive paths
        location ~ ^/(?:build|tests|config|lib|3rdparty|templates|data)(?:$|/) { return 404; }
        location ~ ^/(?:\.|autotest|occ|issue|indie|db_|console) { return 404; }

        # IMPORTANT: отдельный location для merged-template-prepend.js
        location = /js/core/merged-template-prepend.js {
            try_files $uri /index.php$is_args$args;
            access_log off;
            expires 30d;
            add_header Cache-Control "public, max-age=2592000";
        }

        # static assets
        location ~* \.(?:css|js|mjs|woff2?|svg|gif|ico|jpg|jpeg|png|webp)$ {
            expires 30d;
            access_log off;
            add_header Cache-Control "public, max-age=2592000";
            try_files $uri /index.php$is_args$args;
        }

        # main
        location / {
            try_files $uri $uri/ /index.php$is_args$args;
        }

        location ^~ /apps/ {
            try_files $uri /index.php$is_args$args;
        }

        location ~ \.php(?:$|/) {
            fastcgi_split_path_info ^(.+?\.php)(/.*)$;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param PATH_INFO $fastcgi_path_info;
            fastcgi_param modHeadersAvailable true;
            fastcgi_param front_controller_active true;

            fastcgi_pass php-handler;
            fastcgi_intercept_errors on;
            fastcgi_request_buffering off;
        }

        location ~ /\.ht { deny all; }
    }
}
